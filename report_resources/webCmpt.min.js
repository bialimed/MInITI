/*!
  * AnaCore-web thresholdAlert component v1.2.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
class ThresholdAlert{constructor(e,t,s="",r=""){this.text_pre=t,this.rules=e,this.text_post=s,this.value_suffix=r}}Vue.component("threshold-alert",{props:{threshold:{required:!0,type:Object},value:{required:!0}},methods:{getThresholdCategory:function(e,t){let s=null;return Object.keys(e).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).forEach(function(r){parseFloat(r)<=parseFloat(t)&&(s=e[r])}),s}},computed:{category_classes:function(){return"alert alert-"+this.getThresholdCategory(this.threshold.rules,this.value)}},template:'<div :class="category_classes" role="alert">\n            {{threshold.text_pre}} <span class="right-badge">{{value}}{{threshold.value_suffix}}</span> {{threshold.text_post}}\n        </div>'});


/*!
  * AnaCore-web MSI v2.0.0
  * Copyright 2018 CHU Toulouse
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function locusNameOrPos(t){return t.name?t.name:t.position}class MSIReport{constructor(t=null){this.samples=null==t?[]:t}getMethods(){let t=new Set;return this.samples.forEach(e=>{e.getMethods().forEach(e=>{t.add(e)})}),t=Array.from(t).sort()}existsLocusName(){let t=!1;return this.samples.forEach(function(e){for(let s in e.loci)e.loci[s].name&&(t=!0)}),t}getLocusNameByLocusID(){let t={};return this.samples.forEach(e=>{for(let s in e.loci){const r=e.loci[s];t[s]=r.name?r.name:s}}),t}getLoci(){let t=new Set;return this.samples.forEach(e=>{e.getLoci().forEach(e=>{t.add(e)})}),t=Array.from(t).sort()}getResByLocus(){const t=this;let e={};return t.getLoci().forEach(s=>{let r=[];t.samples.forEach(t=>{r.push(t.loci[s])}),e[s]=r}),e}getMostRepresentedByLocus(t,e){let s={};const r=this.getResByLocus();for(let o in r){const l=r[o];let n=[];l.forEach(s=>{if(s.results.hasOwnProperty(t)){const r=s.results[t];if(-1!==e.indexOf(r.status)){const t=r.data.hasOwnProperty("nb_by_length")?r.data.nb_by_length:r.data.lengths.ct_by_len;let e=null,s=-1;for(let r in t)t[r]>=s&&(s=t[r],e=r);n.push(e)}}}),s[o]=n}return s}getNbDeterminedForLocus(t,e){let s=0;return this.samples.forEach(r=>{if(r.loci.hasOwnProperty(t)){const o=r.loci[t];o.results.hasOwnProperty(e)&&("MSI"!=o.results[e].status&&"MSS"!=o.results[e].status||(s+=1))}}),s}static fromJSON(t){let e=new MSIReport;return t.forEach(function(t){e.samples.push(MSISample.fromJSON(t))}),e}}class MSISample{constructor(t,e=null,s=null){this.name=t,this.loci=null===e?{}:e,this.results=null===s?{}:s}getMajorityStatus(){let t=0,e={MSI:0,MSS:0,Undetermined:0};for(let s in this.results){t+=1;const r=this.results[s].status;e[r]+=1}const s=Object.keys(e).sort(function(t,s){return e[t]-e[s]}).reverse()[0];let r=null;return e[s]>.5*t&&(r=s),r}getLoci(){let t=new Set;for(let e in this.loci)t.add(e);return t=Array.from(t).sort()}getMethods(){let t=new Set;for(let e in this.results)t.add(e);return t=Array.from(t).sort()}getNbLoci(){return this.getLoci().length}getNbUnstable(t){const e=this;let s=0;return this.getLoci().forEach(r=>{const o=e.loci[r];o.results.hasOwnProperty(t)&&"MSI"==o.results[t].status&&(s+=1)}),s}getNbDetermined(t){const e=this;let s=0;return this.getLoci().forEach(r=>{const o=e.loci[r];o.results.hasOwnProperty(t)&&("MSI"!=o.results[t].status&&"MSS"!=o.results[t].status||(s+=1))}),s}static fromJSON(t){let e=new MSISample(null);return Object.keys(t).forEach(s=>{e[s]=t[s]}),Object.values(e.results).forEach(t=>{t.sample=e}),e}}


/*!
  * AnaCore-web dynamicTable component v1.12.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
const DynamicTableHeader=Vue.component("dynamic-table-header",{props:{header:{required:!0,type:Array}},computed:{cleaned_header:function(){let e=this.header;return this.is_multi_rows||(e=new Array(e)),e},is_multi_rows:function(){return 0!==this.header.length&&Array.isArray(this.header[0])}},filters:{getRowSpan:function(e){return e.hasOwnProperty("rowspan")?e.rowspan:1},getColSpan:function(e){return e.hasOwnProperty("colspan")?e.colspan:1}},template:'<thead>\n            <tr v-for="row in cleaned_header">\n                <th v-for="col in row"\n                    :class="col.header_class"\n                    :rowspan="col | getRowSpan"\n                    :colspan="col | getColSpan"\n                    data-toggle="popover"\n                    :data-content="col.help">\n                    {{col.title}}\n                </th>\n            </tr>\n        </thead>'}),DynamicTableCell=Vue.component("dynamic-table-cell",{props:{col:{required:!0,type:Object},entry:{required:!0,type:Object}},methods:{getValue:function(e,t){return this.$options.filters.getValue(e,t)}},filters:{getValue:function(e,t){let n=null;return t.hasOwnProperty("value")?n=t.value(e):e.hasOwnProperty(t.title)&&(n=e[t.title]),t.hasOwnProperty("displayFormat")&&(n=t.displayFormat(n)),n},getHref:function(e,t){return t.href(e)},getClass:function(e,t){let n=null;return t.hasOwnProperty("class")&&(n=[t.class]),t.hasOwnProperty("entryClass")&&(added_class=t.entryClass(e),null===n?n=[added_class]:n.push(added_class)),n},getEntryInnerClass:function(e,t){let n=null;return t.hasOwnProperty("entryInnerClass")&&(n=[t.entryInnerClass(e)]),n},getSubClass:function(e,t){let n=null;return t.hasOwnProperty("subEntryClass")&&(added_class=t.subEntryClass(e),null===n?n=[added_class]:n.push(added_class)),n},getSubHref:function(e,t){return t.subEntryHref(e)},getSubSeparator:function(e){let t=" ";return e.hasOwnProperty("subEntrySeparator")&&(t=e.subEntrySeparator),t}},template:'<td :class="entry | getClass(col)">\n            <template v-if="col.is_html">\n                <span v-html="getValue(entry, col)" v-on:click="col.event ? $emit(\'click\', entry) : null"></span>\n            </template>\n            <template v-else>\n                <template v-if="col.href">\n                    <a\n                        :target="col.href_target ? col.href_target : \'_self\'"\n                        :href="entry | getHref(col)"\n                        :class="entry | getEntryInnerClass(col)">\n                        <template v-if="col.is_array">\n                            <template v-for="(sub_value, sub_idx) in getValue(entry, col)">\n                                <span v-if="sub_idx != 0">{{col | getSubSeparator}}</span><span :class="sub_value | getSubClass(col)">{{sub_value}}</span>\n                            </template>\n                        </template>\n                        <template v-else>\n                            {{entry | getValue(col)}}\n                        </template>\n                    </a>\n                </template>\n                <template v-else>\n                    <span :class="entry | getEntryInnerClass(col)">\n                        <template v-if="col.is_array">\n                            <template v-if="col.subEntryHref">\n                                <template v-for="(sub_value, sub_idx) in getValue(entry, col)">\n                                    <span v-if="sub_idx != 0">{{col | getSubSeparator}}</span>\n                                    <a\n                                        :target="col.href_target ? col.href_target : \'_self\'"\n                                        :href="sub_value | getSubHref(col)"\n                                        :class="sub_value | getSubClass(col)">{{sub_value}}</a>\n                                </template>\n                            </template>\n                            <template v-else>\n                                <template v-for="(sub_value, sub_idx) in getValue(entry, col)">\n                                    <span v-if="sub_idx != 0">{{col | getSubSeparator}}</span>\n                                    <span :class="sub_value | getSubClass(col)">{{sub_value}}</span>\n                                </template>\n                            </template>\n                        </template>\n                        <template v-else>\n                            {{entry | getValue(col)}}\n                        </template>\n                    </span>\n                </template>\n            </template>\n        </td>'}),DynamicTable=Vue.component("dynamic-table",{props:{cmpt_id:{type:String,default:function(){return uuid.v4()}},data:Array,export_title:{default:null,type:String},filters:{default:null,type:Object},header:{required:!0,type:Array},menu:{default:function(){return{export:!0,filter:!0,pagination:!0}},type:Object},pagination_sizes:{default:function(){return[10,25,50,100]},array:Array},scroll_x:{default:!1,type:Boolean},scroll_x_fix:{default:0,type:Number},title:String},data:function(){return{error_msg:null}},watch:{data:function(e,t){this.error_msg=null},filters:function(e,t){this.error_msg=null}},mounted:function(){if("TABLE"==$(this.$el)[0].tagName){const e=$(this.$el).DataTable(this.datatableParams);$(e.table().container()).find('[data-toggle="popover"]').popover({container:"body",trigger:"hover",html:!0})}},beforeUpdate:function(){"TABLE"==$(this.$el)[0].tagName&&$(this.$el).DataTable().destroy()},updated:function(){if("TABLE"==$(this.$el)[0].tagName){const e=$(this.$el).DataTable(this.datatableParams);$(e.table().container()).find('[data-toggle="popover"]').popover({container:"body",trigger:"hover",html:!0})}},computed:{is_multi_rows_header:function(){return 0!==this.header.length&&Array.isArray(this.header[0])},nb_columns:function(){let e=0,t=this.header;return this.is_multi_rows_header&&(t=this.header[0]),t.forEach(function(t){t.hasOwnProperty("colspan")?e+=t.colspan:e+=1}),e},header_mask:function(){let e=this.header;if(this.is_multi_rows_header){const t=this.header.length,n=this.nb_columns;(e=new Array(t).fill([])).forEach(function(t,l){e[l]=new Array(n).fill(null)}),this.header.forEach(function(t,n){col_idx=0,t.forEach(function(t){for(;null!==e[n][col_idx];)col_idx+=1;colspan=t.hasOwnProperty("colspan")?t.colspan:1,rowspan=t.hasOwnProperty("rowspan")?t.rowspan:1;for(let l=n;l<n+rowspan;l++)for(let n=col_idx;n<col_idx+colspan;n++)e[l][n]=t;col_idx+=1})})}return e},columns:function(){let e=this.header_mask;return this.is_multi_rows_header&&(e=e[e.length-1]),e},filteredData:function(){let e=this.data;if(null!=this.filters){const t=this;try{e=e.filter(function(e){return t.filters.eval(e)})}catch(e){this.error_msg="Error in data when apply filters."}}return e},datatableParams:function(){order_rule=[[0,"asc"]],this.columns.forEach(function(e,t){e.hasOwnProperty("sort")&&(order_rule=[[t,e.sort]])});let e={columnDefs:[{targets:"no-sort",orderable:!1}],dom:"",lengthMenu:this.pagination_sizes,order:order_rule};return this.scroll_x&&(e.scrollX=!0,0!=this.scroll_x_fix&&(e.fixedColumns={leftColumns:this.scroll_x_fix})),this.menu.pagination&&(this.menu.filter&&(e.dom="f"),this.menu.export?e.dom="<'d-md-none'<'row'<'col-sm-12'B><'col-sm-12'l><'col-sm-12'"+e.dom+"r>>><'d-none d-md-block'<'row'<'col-md-6'<'row'<'dtable-head-btn'B>l>><'col-md-6'"+e.dom+"r>>><'row'<'col-sm-12't>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>":e.dom="<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'"+e.dom+"r>><'row'<'col-sm-12't>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"),this.menu.export&&(null===this.export_title?e.buttons=["csv","excel"]:e.buttons=[{extend:"csv",title:this.export_title},{extend:"excel",title:this.export_title}]),e},datatableStyle:function(){let e={};return this.scroll_x&&(e={width:"100%","border-bottom":"none"}),e}},template:'<template v-if="error_msg">\n            <div class="dtable-error-msg">\n                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-exclamation-circle-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n                    <path fill-rule="evenodd" d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>\n                </svg>\n                {{error_msg}}\n            </div>\n        </template>\n        <template v-else>\n            <table :id=cmpt_id class="table table-striped" :style="datatableStyle">\n                <caption v-if="title">\n                    {{title}}\n                </caption>\n                <dynamic-table-header :header="header"></dynamic-table-header>\n                <tbody>\n                    <tr v-for="entry in filteredData">\n                        <dynamic-table-cell v-for="(col, col_idx) in columns"\n                            v-on:click="col.event ? $emit(col.event, entry) : null"\n                            :entry="entry"\n                            :col="col"\n                        ></dynamic-table-cell>\n                    </tr>\n                </tbody>\n            </table>\n        </template>'});


/*!
  * AnaCore-web msi-graph v2.1.0
  * Copyright 2018 CHU-Toulouse
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function mg_sortNumber(t,e){return t-e}function mg_ntile(t,e,n=100){const i=t.sort(mg_sortNumber);let r=null;if(0==e)r=i[0];else if(e==n)r=i[t.length-1];else{r=i[Math.ceil(e*i.length/n)-1]}return r}function mg_getMSIGraph(t,e,n,i,r=!0,s=null){let l=[],o=1/0,a=-1;t.samples.forEach(function(t){const e=t.loci[n].results[i],s=e.data.hasOwnProperty("nb_by_length")?e.data.nb_by_length:e.data.lengths.ct_by_len,h=Object.keys(s).sort(mg_sortNumber),c=t.loci[n].results[i].status,m=!(!r&&"Undetermined"==c);o=Math.min(h[0],o),a=Math.max(h[h.length-1],a);let d=[];h.forEach(function(t){d.push([parseInt(t),s[t]])}),l.push({name:t.name,data:d,visible:m,zIndex:1})}),min_win_width=30,a-o<min_win_width&&(middle_len=(a-o)/2+o,o=Number.parseInt(middle_len-min_win_width/2-.5),a=Number.parseInt(middle_len+min_win_width/2+.5));let h=[];e&&e.hasOwnProperty(n)&&(h=[{from:mg_ntile(e[n],0),to:mg_ntile(e[n],100),label:{text:"Models most represented length"},className:"max-interval",color:2==l.length?"orange":Highcharts.getOptions().colors[l.length],id:"models_peak"}]);let c={chart:{type:"column",zoomType:"x"},xAxis:{tickInterval:1,min:o,max:a,title:{text:"Length"},plotBands:h},yAxis:{title:{text:"Nb support"}},tooltip:{crosshairs:[!0],shared:!0,formatter:function(){let t=["Nb support for <b>"+this.points[0].x+"nt</b>:"];return $.each(this.points,function(e,n){t.push('<b><span style="color:'+n.series.color+'">'+n.series.name+"</b></span>: <b>"+n.y+"</b>")}),t.join("<br />")}},credits:{enabled:!1},series:l};return null!=s&&(c.title={text:s}),c}const MSILociGraph=Vue.component("msi-loci-graph",{props:{report:Object,models_peaks_by_locus:Object,locus_id:String,undetermined_are_visible:{default:!0,type:Boolean},method:{required:!0,type:String},title:{type:String,default:"Microsatellite length"}},mounted:function(){this.drawGraph()},watch:{locus_id:function(t){this.drawGraph()}},computed:{graph_parameters:function(){return mg_getMSIGraph(this.report,this.models_peaks_by_locus,this.locus_id,this.method,this.undetermined_are_visible,this.title)}},methods:{drawGraph:function(){const t=this.$el,e=$(window).scrollTop();Highcharts.chart(t,this.graph_parameters),$(window).scrollTop(e)}},template:"<div></div>"});


/*!
  * AnaCore-web msi-sample-table v2.1.0
  * Copyright 2018 CHU-Toulouse
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function mst_getScoreClasses(e,t){let s="danger";return t.forEach(t=>{const[a,n]=t;a<=e&&(s=n)}),["msi-label","msi-label-"+s]}function mst_getSupportClasses(e,t){let s="danger";return t.forEach(t=>{const[a,n]=t;a<=e&&(s=n)}),"na"!=s?["msi-label","msi-label-"+s]:[""]}const MSISampleTable=Vue.component("msi-sample-table",{props:{analysis:{type:Object,required:!0},class_by_score:{type:Object,default:function(){return{.7:"danger",.95:"good"}}},class_by_support_rate:{type:Object,default:function(){return{0:"danger",.66:"warning",.75:"na"}}},title:{default:"Status by method",type:String}},computed:{rows_data:function(){let e=[];return this.analysis.samples.forEach(function(t){Object.values(t.results).forEach(function(t){e.push(t)})}),e},header:function(){const e=this;let t=[{title:"Method",help:"Method used to determine stability status of sample.",value:function(e,t){return e.method}},{title:"Status",class:"msi-sticker",entryClass:function(e,t){return e.status},help:"Stability status prediction.",value:function(e,t){return e.status}},{title:"Score",is_html:!0,help:"Confidence score for status prediction.",value:function(t,s){let a=t.score;if(a&&"Undetermined"!=t.status){a=`<span class="${mst_getScoreClasses(a,e.scores_classes).join(" ")}">${a.toFixed(2)}</span>`}return a},sort:"desc"},{title:"Instability rate",help:"Number of unstable loci / Number of usable loci.",value:function(e,t){let s=null;return 0!=e.sample.getNbDetermined(e.method)&&(s=(e.sample.getNbUnstable(e.method)/e.sample.getNbDetermined(e.method)).toFixed(2)),s}},{title:"Support",help:"Number of usable loci.",is_html:!0,value:function(t,s){return`<span class="${mst_getSupportClasses(t.sample.getNbDetermined(t.method)/t.sample.getNbLoci(),e.supports_classes).join(" ")}">${t.sample.getNbDetermined(t.method)}</span>`}}];return this.analysis.samples.length>1&&t.unshift({title:"Sample",value:function(e,t){return e.sample.name}}),t},scores_classes:function(){return Object.keys(this.class_by_score).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).map(e=>[parseFloat(e),this.class_by_score[e]])},supports_classes:function(){return Object.keys(this.class_by_support_rate).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).map(e=>[parseFloat(e),this.class_by_support_rate[e]])}},template:'<dynamic-table\n        :data="rows_data"\n        :header="header"\n        :title="title">\n    </dynamic-table>'});


/*!
  * AnaCore-web msi-sample-card v2.0.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
Vue.component("msi-sample-card",{props:{analysis:{type:Object,required:!0},class_by_score:{type:Object,default:function(){return{.7:"warning",.95:"good"}}},class_by_support_rate:{type:Object,default:function(){return{.5:"warning",.7:"na"}}}},template:'<div class="row">\n        <div class="col-md-1"></div>\n        <div class="col-md-10">\n            <msi-sample-table\n                :analysis="analysis"\n                :class-by-score="class_by_score"\n                :class-by-support-rate="class_by_support_rate">\n            </msi-sample-table>\n        </div>\n    </div>'});


/*!
  * AnaCore-web msi-loci-card v2.0.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function mlc_getScoreClasses(e){let t="danger";return Object.keys(mlc_class_by_score).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).forEach(function(s){parseFloat(s)<=parseFloat(e)&&(t=mlc_class_by_score[s])}),"msi-label msi-label-"+t}mlc_class_by_score=null,Vue.component("msi-loci-card",{props:{analysis:{type:Object,required:!0},class_by_score:{type:Object,default:function(){return{.7:"warning",.95:"good"}}},model_peaks:{type:Object,required:!0},reference_method:{type:String,default:"SVC"},loci_select_threshold:{type:Object,default:function(){return new ThresholdAlert({100:"danger",0:"good"},"","of samples with insufficient support","%")}}},data:function(){return{selected_locus:null}},created:function(){mlc_class_by_score=this.class_by_score;const e=this.analysis.getLocusNameByLocusID(),t=Object.keys(e).sort(function(t,s){return e[t]>e[s]});this.selected_locus=t[0]},computed:{options_select_locus:function(){let e=null;if(null!==this.analysis){e=[];const t=this.analysis.getLocusNameByLocusID();Object.keys(t).sort(function(e,s){return t[e]<t[s]}).forEach(function(s){e.splice(0,0,{value:s,label:t[s]})})}return e},loci_select_support:function(){return(100*(this.analysis.samples.length-this.analysis.getNbDeterminedForLocus(this.selected_locus,this.reference_method))).toFixed(0)},loci_table_data:function(){return Object.values(this.analysis.getResByLocus())},loci_table_columns:function(){const e=this;let t=[{rowspan:2,title:"Locus ID",value:function(e,t){return e[0].position}},{rowspan:2,title:"Locus name",sort:"asc",value:function(e,t){return e[0].name}}],s=[];return this.analysis.samples.forEach(function(n,l){const o=n.getMethods(),c=o.length+1;t.push({colspan:c,title:n.name}),o.forEach(function(t){t==e.reference_method&&s.splice(l*c,0,{title:"Support",value:function(e,s){return Object.values(e[l].results[t].data.nb_by_length).reduce(function(e,t){return e+t},0)}}),s.push({title:t,class:"msi-sticker",entryClass:function(e,s){return e[l].results[t].status},is_html:!0,value:function(e,s){let n=[],o=e[l].results[t].score;if(null!==o){const e=mlc_getScoreClasses(o=Number.parseFloat(o.toFixed(2)));n.push('<span class="'+e+'">'+o.toFixed(2)+"</span>")}let c=e[l].results[t].status;return"Undetermined"==c&&(c="Unknown"),n.push(c),n.join(" ")}})})}),[t,s]}},template:'<div>\n        \x3c!-- loci graph --\x3e\n        <div class="row row-block">\n            <div class="col-md-10">\n                <msi-graph\n                    :report="analysis"\n                    :undetermined_are_visible="false"\n                    :models_peaks_by_locus="model_peaks"\n                    :locus_id="selected_locus"\n                    :method="reference_method">\n                </msi-graph>\n            </div>\n            <div class="col-md-2">\n                <select class="custom-select" v-model="selected_locus">\n                    <option v-for="option in options_select_locus" :value="option.value">\n                        {{option.label}}\n                    </option>\n                </select>\n                <div style="margin-top: 5px;">\n                    <threshold-alert\n                        :threshold="loci_select_threshold"\n                        :value="loci_select_support">\n                    </threshold-alert>\n                </div>\n            </div>\n        </div>\n        \x3c!-- loci table --\x3e\n        <div class="row">\n            <div class="col-md-12">\n                <dynamic-table\n                    :data="loci_table_data"\n                    export_title="MSI_by_locus"\n                    :header="loci_table_columns"\n                    title="Status by locus">\n                </dynamic-table>\n            </div>\n        </div>\n    </div>'});
