/*!
  * AnaCore-web thresholdAlert component v1.2.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
class ThresholdAlert{constructor(e,t,s="",r=""){this.text_pre=t,this.rules=e,this.text_post=s,this.value_suffix=r}}Vue.component("threshold-alert",{props:{threshold:{required:!0,type:Object},value:{required:!0}},methods:{getThresholdCategory:function(e,t){let s=null;return Object.keys(e).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).forEach(function(r){parseFloat(r)<=parseFloat(t)&&(s=e[r])}),s}},computed:{category_classes:function(){return"alert alert-"+this.getThresholdCategory(this.threshold.rules,this.value)}},template:'<div :class="category_classes" role="alert">\n            {{threshold.text_pre}} <span class="right-badge">{{value}}{{threshold.value_suffix}}</span> {{threshold.text_post}}\n        </div>'});


/*!
  * AnaCore-web MSI v1.1.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
class MSIReport{constructor(t=null){this.samples=null===t?[]:t}getMethods(){let t=new Set;return this.samples.forEach(function(e){e.getMethods().forEach(function(e){t.add(e)})}),t=Array.from(t).sort()}getLocusNameByLocusID(){let t={};return this.samples.forEach(function(e){for(let s in e.loci){const r=e.loci[s];t[s]=r.name}}),t}getLoci(){let t=new Set;return this.samples.forEach(function(e){e.getLoci().forEach(function(e){t.add(e)})}),t=Array.from(t).sort()}getResByLocus(){const t=this;let e={};return t.getLoci().forEach(function(s){let r=[];t.samples.forEach(function(t){r.push(t.loci[s])}),e[s]=r}),e}getMostRepresentedByLocus(t,e){let s={};const r=this.getResByLocus();for(let o in r){const n=r[o];let l=[];n.forEach(function(s){if(s.results.hasOwnProperty(t)){const r=s.results[t];if(-1!=e.indexOf(r.status)){const t=r.data.nb_by_length;let e=null,s=-1;for(let r in t)t[r]>=s&&(s=t[r],e=r);l.push(e)}}}),s[o]=l}return s}getNbDeterminedForLocus(t,e){let s=0;return this.samples.forEach(function(r){if(r.loci.hasOwnProperty(t)){const o=r.loci[t];o.results.hasOwnProperty(e)&&("MSI"!=o.results[e].status&&"MSS"!=o.results[e].status||(s+=1))}}),s}static fromJSON(t){let e=new MSIReport;return t.forEach(function(t){e.samples.push(MSISample.fromJSON(t))}),e}}class MSISample{constructor(t,e=null,s=null){this.name=t,this.loci=null===e?{}:e,this.results=null===s?{}:s}getMajorityStatus(){let t=0,e={MSI:0,MSS:0,Undetermined:0};for(let s in this.results){t+=1;const r=this.results[s].status;e[r]+=1}const s=Object.keys(e).sort(function(t,s){return e[t]-e[s]}).reverse()[0];let r=null;return e[s]>.5*t&&(r=s),r}getLoci(){let t=new Set;for(let e in this.loci)t.add(e);return t=Array.from(t).sort()}getMethods(){let t=new Set;for(let e in this.results)t.add(e);return t=Array.from(t).sort()}getNbLoci(){return this.getLoci().length}getNbUnstable(t){const e=this;let s=0;return this.getLoci().forEach(function(r){const o=e.loci[r];o.results.hasOwnProperty(t)&&"MSI"==o.results[t].status&&(s+=1)}),s}getNbDetermined(t){const e=this;let s=0;return this.getLoci().forEach(function(r){const o=e.loci[r];o.results.hasOwnProperty(t)&&("MSI"!=o.results[t].status&&"MSS"!=o.results[t].status||(s+=1))}),s}static fromJSON(t){let e=new MSISample(null);return Object.keys(t).forEach(function(s){e[s]=t[s]}),Object.values(e.results).forEach(function(t){t.sample=e}),e}}


/*!
  * AnaCore-web dynamicTable component v1.4.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
DynamicTable=Vue.component("dynamic-table",{props:{data:Array,filters:Object,header:{required:!0,type:Array},pagination_sizes:{default:function(){return[10,25,50,100]},array:Array},menu:{default:function(){return{export:!0,filter:!0,pagination:!0}},type:Object},export_title:{default:null,type:String},scroll_x:{default:!1,type:Boolean},scroll_x_fix:{default:0,type:Number},title:String},mounted:function(){$(this.$el).DataTable(this.datatableParams)},computed:{is_multi_rows_header:function(){return 0!==this.header.length&&Array.isArray(this.header[0])},nb_columns:function(){let t=0,e=this.header;return this.is_multi_rows_header&&(e=this.header[0]),e.forEach(function(e){e.hasOwnProperty("colspan")?t+=e.colspan:t+=1}),t},header_mask:function(){let t=this.header;if(this.is_multi_rows_header){const e=this.header.length,l=this.nb_columns;(t=new Array(e).fill([])).forEach(function(e,n){t[n]=new Array(l).fill(null)}),this.header.forEach(function(e,l){col_idx=0,e.forEach(function(e){for(;null!==t[l][col_idx];)col_idx+=1;colspan=e.hasOwnProperty("colspan")?e.colspan:1,rowspan=e.hasOwnProperty("rowspan")?e.rowspan:1;for(let n=l;n<l+rowspan;n++)for(let l=col_idx;l<col_idx+colspan;l++)t[n][l]=e;col_idx+=1})})}return t},columns:function(){let t=this.header_mask;return this.is_multi_rows_header&&(t=t[t.length-1]),t},filteredData:function(){let t=this.data;if(null!=this.filters){const e=this;t=t.filter(function(t){return e.filters.eval(t)})}return t},datatableParams:function(){order_rule=[[0,"asc"]],this.columns.forEach(function(t,e){t.hasOwnProperty("sort")&&(order_rule=[[e,t.sort]])});let t={dom:"",order:order_rule,lengthMenu:this.pagination_sizes};return this.scroll_x&&(t.scrollX=!0,0!=this.scroll_x_fix&&(t.fixedColumns={leftColumns:this.scroll_x_fix})),this.menu.pagination&&(this.menu.filter&&(t.dom="f"),this.menu.export?t.dom="<'d-md-none'<'row'<'col-sm-12'B><'col-sm-12'l><'col-sm-12'"+t.dom+"r>>><'d-none d-md-block'<'row'<'col-md-6'<'row'<'dtable-head-btn'B>l>><'col-md-6'"+t.dom+"r>>><'row'<'col-sm-12't>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>":t.dom="<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'"+t.dom+"r>><'row'<'col-sm-12't>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"),this.menu.export&&(null===this.export_title?t.buttons=["csv","excel"]:t.buttons=[{extend:"csv",title:this.export_title},{extend:"excel",title:this.export_title}]),t},datatableStyle:function(){let t={};return this.scroll_x&&(t={width:"100%","border-bottom":"none"}),t}},beforeUpdate:function(){$(this.$el).DataTable().destroy()},updated:function(){$(this.$el).DataTable(this.datatableParams)},methods:{getValue:function(t,e){return this.$options.filters.getValue(t,e)}},filters:{getValue:function(t,e){let l=null;return e.hasOwnProperty("value")?l=e.value(t):t.hasOwnProperty(e.title)&&(l=t[e.title]),l},getHref:function(t,e){return e.href(t)},getClass:function(t,e){let l=null;return e.hasOwnProperty("class")&&(l=[e.class]),e.hasOwnProperty("entryClass")&&(added_class=e.entryClass(t),null===l?l=[added_class]:l.push(added_class)),l},getSubClass:function(t,e){let l=null;return e.hasOwnProperty("subEntryClass")&&(added_class=e.subEntryClass(t),null===l?l=[added_class]:l.push(added_class)),l},getSubHref:function(t,e){return e.subEntryHref(t)},getSubSeparator:function(t){let e=" ";return t.hasOwnProperty("subEntrySeparator")&&(e=t.subEntrySeparator),e},getRowSpan:function(t){return t.hasOwnProperty("rowspan")?t.rowspan:1},getColSpan:function(t){return t.hasOwnProperty("colspan")?t.colspan:1}},template:'<table class="table table-striped" :style="datatableStyle">\n\t\t\t<caption>\n\t\t\t\t{{title}}\n\t\t\t</caption>\n\t\t\t<thead>\n\t\t\t\t<template v-if="!is_multi_rows_header">\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<th v-for="col in columns">{{col.title}}</th>\n\t\t\t\t\t</tr>\n\t\t\t\t</template>\n\t\t\t\t<template v-else>\n\t\t\t\t\t<tr v-for="row in header">\n\t\t\t\t\t\t<th v-for="col in row"\n\t\t\t\t\t\t\t:rowspan="col | getRowSpan"\n\t\t\t\t\t\t\t:colspan="col | getColSpan">\n\t\t\t\t\t\t\t{{col.title}}\n\t\t\t\t\t\t</th>\n\t\t\t\t\t</tr>\n\t\t\t\t</template>\n\t\t\t</thead>\n\t\t\t<tbody>\n\t\t\t\t<tr v-for="entry in filteredData">\n\t\t\t\t\t<td v-for="(col, col_idx) in columns" :class="entry | getClass(col)">\n\t\t\t\t\t\t<template v-if="col.is_html">\n\t\t\t\t\t\t\t<span v-html="getValue(entry, col)" v-on:click="col.event ? $emit(col.event, entry) : null"></span>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t<template v-if="col.href">\n\t\t\t\t\t\t\t\t<a :target="col.href_target ? col.href_target : \'_self\'" :href="entry | getHref(col)">\n\t\t\t\t\t\t\t\t\t<template v-if="col.is_array">\n\t\t\t\t\t\t\t\t\t\t<template v-for="(sub_value, sub_idx) in getValue(entry, col)">\n\t\t\t\t\t\t\t\t\t\t\t<span v-if="sub_idx != 0">{{col | getSubSeparator}}</span><span :class="sub_value | getSubClass(col)">{{sub_value}}</span>\n\t\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t\t\t{{entry | getValue(col)}}\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t<template v-if="col.is_array">\n\t\t\t\t\t\t\t\t\t<template v-if="col.subEntryHref">\n\t\t\t\t\t\t\t\t\t\t<template v-for="(sub_value, sub_idx) in getValue(entry, col)">\n\t\t\t\t\t\t\t\t\t\t\t<span v-if="sub_idx != 0">{{col | getSubSeparator}}</span>\n\t\t\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\t\t\t:target="col.href_target ? col.href_target : \'_self\'"\n\t\t\t\t\t\t\t\t\t\t\t\t:href="sub_value | getSubHref(col)"\n\t\t\t\t\t\t\t\t\t\t\t\t:class="sub_value | getSubClass(col)">{{sub_value}}</a>\n\t\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t\t\t<template v-for="(sub_value, sub_idx) in getValue(entry, col)">\n\t\t\t\t\t\t\t\t\t\t\t<span v-if="sub_idx != 0">{{col | getSubSeparator}}</span>\n\t\t\t\t\t\t\t\t\t\t\t<span :class="sub_value | getSubClass(col)">{{sub_value}}</span>\n\t\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t\t{{entry | getValue(col)}}\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t</tbody>\n\t\t</table>'});


/*!
  * AnaCore-web msi-graph v2.0.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function mg_sortNumber(t,e){return t-e}function mg_ntile(t,e,n=100){const i=t.sort(mg_sortNumber);let s=null;if(0==e)s=i[0];else if(e==n)s=i[t.length-1];else{s=i[Math.ceil(e*i.length/n)-1]}return s}function mg_getMSIGraph(t,e,n,i,s=!0,r=null){let l=[],o=1/0,a=-1;t.samples.forEach(function(t){const e=t.loci[n].results[i].data.nb_by_length,r=Object.keys(e).sort(mg_sortNumber),h=t.loci[n].results[i].status,m=!(!s&&"Undetermined"==h);o=Math.min(r[0],o),a=Math.max(r[r.length-1],a);let c=[];r.forEach(function(t){c.push([parseInt(t),e[t]])}),l.push({name:t.name,data:c,visible:m,zIndex:1})}),min_win_width=30,a-o<min_win_width&&(middle_len=(a-o)/2+o,o=Number.parseInt(middle_len-min_win_width/2-.5),a=Number.parseInt(middle_len+min_win_width/2+.5));let h=[];e.hasOwnProperty(n)&&(h=[{from:mg_ntile(e[n],0),to:mg_ntile(e[n],100),label:{text:"Models most represented length"},className:"max-interval",color:2==l.length?"orange":Highcharts.getOptions().colors[l.length],id:"models_peak"}]);let m={chart:{type:"column",zoomType:"x"},xAxis:{tickInterval:1,min:o,max:a,title:{text:"Length"},plotBands:h},yAxis:{title:{text:"Nb support"}},tooltip:{crosshairs:[!0],shared:!0,formatter:function(){let t=["Nb support for <b>"+this.points[0].x+"nt</b>:"];return $.each(this.points,function(e,n){t.push('<b><span style="color:'+n.series.color+'">'+n.series.name+"</b></span>: <b>"+n.y+"</b>")}),t.join("<br />")}},credits:{enabled:!1},series:l};return null!=r&&(m.title={text:r}),m}Vue.component("msi-graph",{props:{report:Object,models_peaks_by_locus:Object,locus_id:String,undetermined_are_visible:{type:Boolean,default:!0},method:{type:String,default:"MIAmSClassif"},title:{type:String,default:"Microsatellite length"}},mounted:function(){this.drawGraph()},watch:{locus_id:function(t){this.drawGraph()}},computed:{graph_parameters:function(){return mg_getMSIGraph(this.report,this.models_peaks_by_locus,this.locus_id,this.method,this.undetermined_are_visible,this.title)}},methods:{drawGraph:function(){const t=this.$el,e=$(window).scrollTop();Highcharts.chart(t,this.graph_parameters),$(window).scrollTop(e)}},template:"<div></div>"});


/*!
  * AnaCore-web msi-sample-table v2.0.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function mst_getScoreClasses(t){let e="danger";return Object.keys(mst_class_by_score).sort(function(t,e){return parseFloat(t)-parseFloat(e)}).forEach(function(s){parseFloat(s)<=parseFloat(t)&&(e=mst_class_by_score[s])}),"msi-label msi-label-"+e}function mst_getSupportClasses(t){let e="danger";return Object.keys(mst_class_by_support_rate).sort(function(t,e){return parseFloat(t)-parseFloat(e)}).forEach(function(s){parseFloat(s)<=parseFloat(t)&&(e=mst_class_by_support_rate[s])}),"na"!=e?"msi-label msi-label-"+e:""}mst_class_by_score=null,mst_class_by_support_rate=null,Vue.component("msi-sample-table",{props:{analysis:{type:Object,required:!0},class_by_score:{type:Object,default:function(){return{.7:"warning",.95:"good"}}},class_by_support_rate:{type:Object,default:function(){return{.5:"warning",.7:"na"}}},title:{type:String,default:"Status by method"}},data:{selected_locus:null},created:function(){mst_class_by_score=this.class_by_score,mst_class_by_support_rate=this.class_by_support_rate},computed:{sample_table_data:function(){let t=[];return this.analysis.samples.forEach(function(e){Object.values(e.results).forEach(function(e){t.push(e)})}),t},sample_table_columns:function(){let t=[{title:"Method",value:function(t,e){return t.method}},{title:"Status",class:"msi-sticker",entryClass:function(t,e){return t.status},value:function(t,e){return t.status}},{title:"Score",is_html:!0,value:function(t,e){let s=null;return"Undetermined"!=t.status&&(s=`<span class="${mst_getScoreClasses(t.score)}">${t.score.toFixed(2)}</span>`),s},sort:"desc"},{title:"Instability rate",value:function(t,e){let s=null;return 0!=t.sample.getNbDetermined(t.method)&&(s=(t.sample.getNbUnstable(t.method)/t.sample.getNbDetermined(t.method)).toFixed(2)),s}},{title:"Support",is_html:!0,value:function(t,e){return`<span class="${mst_getSupportClasses(t.sample.getNbDetermined(t.method)/t.sample.getNbLoci())}">${t.sample.getNbDetermined(t.method)}</span>`}}];return this.analysis.samples.length>1&&t.unshift({title:"Sample",value:function(t,e){return t.sample.name}}),t}},template:'<dynamic-table\n        :data="sample_table_data"\n        :header="sample_table_columns"\n        :title="title"\n        :menu="{}">\n    </dynamic-table>'});


/*!
  * AnaCore-web msi-sample-card v2.0.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
Vue.component("msi-sample-card",{props:{analysis:{type:Object,required:!0},class_by_score:{type:Object,default:function(){return{.7:"warning",.95:"good"}}},class_by_support_rate:{type:Object,default:function(){return{.5:"warning",.7:"na"}}}},template:'<div class="row">\n        <div class="col-md-1"></div>\n        <div class="col-md-10">\n            <msi-sample-table\n                :analysis="analysis"\n                :class-by-score="class_by_score"\n                :class-by-support-rate="class_by_support_rate">\n            </msi-sample-table>\n        </div>\n    </div>'});


/*!
  * AnaCore-web msi-loci-card v2.0.0
  * Copyright 2018 IUCT-O
  * Author Frederic Escudie
  * Licensed under GNU General Public License
  */
function mlc_getScoreClasses(e){let t="danger";return Object.keys(mlc_class_by_score).sort(function(e,t){return parseFloat(e)-parseFloat(t)}).forEach(function(s){parseFloat(s)<=parseFloat(e)&&(t=mlc_class_by_score[s])}),"msi-label msi-label-"+t}mlc_class_by_score=null,Vue.component("msi-loci-card",{props:{analysis:{type:Object,required:!0},class_by_score:{type:Object,default:function(){return{.7:"warning",.95:"good"}}},model_peaks:{type:Object,required:!0},reference_method:{type:String,default:"SVC"},loci_select_threshold:{type:Object,default:function(){return new ThresholdAlert({100:"danger",0:"good"},"","of samples with insufficient support","%")}}},data:function(){return{selected_locus:null}},created:function(){mlc_class_by_score=this.class_by_score;const e=this.analysis.getLocusNameByLocusID(),t=Object.keys(e).sort(function(t,s){return e[t]>e[s]});this.selected_locus=t[0]},computed:{options_select_locus:function(){let e=null;if(null!==this.analysis){e=[];const t=this.analysis.getLocusNameByLocusID();Object.keys(t).sort(function(e,s){return t[e]<t[s]}).forEach(function(s){e.splice(0,0,{value:s,label:t[s]})})}return e},loci_select_support:function(){return(100*(this.analysis.samples.length-this.analysis.getNbDeterminedForLocus(this.selected_locus,this.reference_method))).toFixed(0)},loci_table_data:function(){return Object.values(this.analysis.getResByLocus())},loci_table_columns:function(){const e=this;let t=[{rowspan:2,title:"Locus ID",value:function(e,t){return e[0].position}},{rowspan:2,title:"Locus name",sort:"asc",value:function(e,t){return e[0].name}}],s=[];return this.analysis.samples.forEach(function(n,l){const o=n.getMethods(),c=o.length+1;t.push({colspan:c,title:n.name}),o.forEach(function(t){t==e.reference_method&&s.splice(l*c,0,{title:"Support",value:function(e,s){return Object.values(e[l].results[t].data.nb_by_length).reduce(function(e,t){return e+t},0)}}),s.push({title:t,class:"msi-sticker",entryClass:function(e,s){return e[l].results[t].status},is_html:!0,value:function(e,s){let n=[],o=e[l].results[t].score;if(null!==o){const e=mlc_getScoreClasses(o=Number.parseFloat(o.toFixed(2)));n.push('<span class="'+e+'">'+o.toFixed(2)+"</span>")}let c=e[l].results[t].status;return"Undetermined"==c&&(c="Unknown"),n.push(c),n.join(" ")}})})}),[t,s]}},template:'<div>\n        \x3c!-- loci graph --\x3e\n        <div class="row row-block">\n            <div class="col-md-10">\n                <msi-graph\n                    :report="analysis"\n                    :undetermined_are_visible="false"\n                    :models_peaks_by_locus="model_peaks"\n                    :locus_id="selected_locus"\n                    :method="reference_method">\n                </msi-graph>\n            </div>\n            <div class="col-md-2">\n                <select class="custom-select" v-model="selected_locus">\n                    <option v-for="option in options_select_locus" :value="option.value">\n                        {{option.label}}\n                    </option>\n                </select>\n                <div style="margin-top: 5px;">\n                    <threshold-alert\n                        :threshold="loci_select_threshold"\n                        :value="loci_select_support">\n                    </threshold-alert>\n                </div>\n            </div>\n        </div>\n        \x3c!-- loci table --\x3e\n        <div class="row">\n            <div class="col-md-12">\n                <dynamic-table\n                    :data="loci_table_data"\n                    export_title="MSI_by_locus"\n                    :header="loci_table_columns"\n                    title="Status by locus">\n                </dynamic-table>\n            </div>\n        </div>\n    </div>'});
